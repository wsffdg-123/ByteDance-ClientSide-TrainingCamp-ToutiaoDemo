## 仿今日头条新闻列表页 Demo 文档

---

## Part 1: 分析实现方式 💡

本项目旨在使用现代 Android 技术栈 (**Kotlin, ComposeUI, 协程, Room**) 实现一个高仿今日头条首页新闻列表的 Demo，采用 **MVVM (Model-View-ViewModel)** 架构，结合 **Kotlin Flow** 进行响应式状态管理。

### 1. 技术栈选型

| 技术栈 | 用途 | 优势 |
| :--- | :--- | :--- |
| **Kotlin** | 编程语言 | 简洁、安全、与 Coroutines 完美集成。 |
| **ComposeUI** | 界面构建 | 声明式 UI，简化布局代码，提升开发效率。 |
| **Kotlin Coroutines** | 异步操作 | 高效的并发模型，用于网络请求、数据库读写和状态流处理。 |
| **Retrofit** | 网络请求 | 类型安全的 HTTP 客户端，易于集成协程。 |
| **Room** | 本地数据缓存 | 抽象 SQLite 数据库，提供易用的 API 和编译时检查。 |
| **Coil/Glide** | 图片加载 | 异步加载和缓存网络图片，支持 Compose 集成。 |

### 2. 架构模式：MVVM + Repository

我们选择 **MVVM** 模式，因为它能很好地分离 UI 逻辑和业务逻辑，并便于测试。

* **View (Composable):** 仅负责 UI 渲染和用户事件处理。它通过观察 **`ViewModel`** 暴露的 **`StateFlow<NewsListState>`** 来响应数据变化。
* **ViewModel:** 负责持有和管理 UI 状态，并处理 UI 交互逻辑（如分页、刷新）。它不直接接触数据源，而是调用 **`Repository`**。
* **Repository:** 作为数据源的唯一入口，负责协调网络 (**Retrofit**) 和本地数据库 (**Room**) 的数据请求，实现数据缓存策略。

### 3. 核心功能实现分析

| 功能点 | 实现方式 | 依赖技术 |
| :--- | :--- | :--- |
| **列表渲染** | 使用 **`LazyColumn`** 结合 **多卡片 Composable**。 | ComposeUI |
| **数据流管理** | **`ViewModel`** 暴露 **`StateFlow`**，**`Repository`** 暴露 **`Flow`**。 | Kotlin Coroutines/Flow |
| **下拉刷新** | 使用 **Pull-to-Refresh** 库包装 **`LazyColumn`**，触发 **`ViewModel.refresh()`**。 | ComposeUI, Coroutines |
| **加载更多** | 监听 **`LazyColumn`** 滚动到末尾的索引，触发 **`ViewModel.loadMore()`**。 | ComposeUI, Coroutines |
| **离线缓存** | **`Repository`** 实现 **Cache-then-Network** 策略，使用 **Room** 存储新闻数据。 | Room, Coroutines |

---

## Part 2: UML 结构 (类图) 🏛️

本项目的核心类图展示了 MVVM 架构下的主要组件及其关系。 

$$
\begin{array}{|c|}
\hline
\text{UI Layer} \\
\hline
\end{array}
\xrightarrow{\text{Observe State}}
\begin{array}{|c|}
\hline
\text{ViewModel Layer} \\
\hline
\end{array}
\xrightarrow{\text{Request Data}}
\begin{array}{|c|}
\hline
\text{Data Layer} \\
\hline
\end{array}
$$

### 核心类和接口

| 类/接口 | 类型 | 描述 |
| :--- | :--- | :--- |
| **`MainActivity`** | Activity | 包含所有 Composable 的宿主。 |
| **`NewsListScreen`** | Composable | 根 Composable，持有 **`ViewModel`**，观察 **`state`**。 |
| **`NewsViewModel`** | ViewModel | 持有 `StateFlow<NewsListState>`，与 Repository 交互。 |
| **`NewsListState`** | Data Class | 定义 UI 状态 (Loading, Success, Error, Data List)。 |
| **`NewsRepository`** | Repository | 协调 **`ApiDataSource`** 和 **`LocalDataSource`**。 |
| **`NewsApi`** | Interface | Retrofit 接口，定义网络请求方法。 |
| **`NewsDao`** | DAO | Room 接口，定义数据库操作方法 (Insert, Query)。 |
| **`NewsItem`** | Data Class | 领域模型/网络数据模型。 |
| **`NewsEntity`** | Entity | Room 数据库实体 (可与 `NewsItem` 相同或转换)。 |

---

## Part 3: 主要流程图 🔄

本项目最核心的流程是**首次数据加载与缓存策略**。

### 首次数据加载与缓存流程图

这是一个 **"Cache-First, Then Network"** 的策略，旨在优先显示缓存数据，并在后台更新数据。

1.  **View 触发:** **`NewsListScreen`** 首次创建，调用 **`NewsViewModel.loadData()`**。
2.  **ViewModel 转换状态:** ViewModel 发送 **Loading** 状态。
3.  **Repository 请求:**
    * **步骤 3.1 (Room):** `Repository` 首先查询 `NewsDao` 尝试获取本地缓存。
    * **步骤 3.2 (Network):** 同时或紧接着调用 `NewsApi` 请求最新数据。
4.  **数据流响应:**
    * **如果 Room 返回数据 (缓存):** `Repository` 将缓存数据作为 **Success** 状态通过 **Flow** 发送给 **`ViewModel`**。View 立即显示旧数据。
    * **如果 Network 返回数据 (最新):** `Repository` 将新数据写入 **Room** (`NewsDao.insertAll()`)，然后 **Room** 会自动触发 **Flow**。
5.  **View 最终渲染:** **`ViewModel`** 接收到最新的数据流，发送新的 **Success** 状态，**`NewsListScreen`** 渲染最新的新闻列表。



---

## Part 4: 工作拆分 + 排期 📅

项目排期总共预估 **4 天**，分为四个主要阶段。

### 任务拆分与工时预估

| 阶段 | 任务内容 | 技术点 | 预估工时 | 负责人 |
| :--- | :--- | :--- | :--- | :--- |
| **Day 1: 基础架构** | **架构搭建：** 设置 Gradle、依赖库（Compose, Coroutines, Hilt/Koin, Retrofit, Room）。**数据模型：** 定义 `NewsItem` 和 `NewsListState`。**基础 UI：** 实现 `MainActivity` 和 `NewsListScreen`，显示 Loading/Error 状态。 | Kotlin, Compose Setup, Data Class | 1 天 | 待定 |
| **Day 2: 核心功能** | **ViewModel：** 实现 `NewsViewModel`，处理状态转换 (`StateFlow`)。**Repository：** 实现 `NewsRepository`，模拟网络请求 (Mock Data)。**列表卡片：** 实现 2 种新闻卡片 (单图/三图) 的 Composable。 | MVVM, Coroutines, ComposeUI | 1 天 | 待定 |
| **Day 3: 进阶功能** | **数据缓存：** 集成 **Room**，定义 `NewsEntity` 和 `NewsDao`。**缓存策略：** 在 `NewsRepository` 中实现 "Cache-First" 逻辑。**分页加载：** 实现加载更多 (Load More) 逻辑。 | Room, Repository Logic, Pagination | 1 天 | 待定 |
| **Day 4: 优化与收尾** | **下拉刷新：** 集成 Pull-to-Refresh 库，实现刷新逻辑。**代码规范：** 代码审查和优化，确保规范性。**文档撰写：** 完善 README 和技术文档。 | Compose UI, Code Quality, Git | 1 天 | 待定 |

### 总排期表

| 日期 | 星期 | 关键里程碑 |
| :--- | :--- | :--- |
| D1 | TUE | **基础架构搭建完成**，`NewsListScreen` 能够显示基础状态。 |
| D2 | WED | **核心列表展示完成**，`NewsViewModel` 能够从 Mock Repository 获取并展示数据。 |
| D3 | THU | **数据持久化完成**，列表支持缓存和分页加载。 |
| D4 | FRI | **Demo 优化完成**，包含下拉刷新，并通过代码规范审查。 |
